{"version":3,"sources":["../../../../src/jx/core/presets/StageGameModule.js"],"names":["StageGameModule","dataObject","Object","assign","renderMode","stageWidth","stageHeight","ratio","forceIOSStageResize","_killed","jx","playVideo","stage","_appFreezed","_stateBeforeFreeze","callback","cc","type","width","config","app","defaultStageResolution","height","fixedStageScale","undefined","params","id","loops","zap","zapMarkers","bgMusicVolPC","onfinished","onready","layerLevel","autoplay","_videosList","rid","choosenResolution","toUpperCase","str","resource","db","findOne","console","error","video","render","visible","addChild","view","$","log","parent","finished","onclick","removeAll","paused","pause","dj","music","volume","volumeOld","target","addOnce","hasBeginPlay","onplaying","add","loadingScreen","hide","fitIn","x","y","alignV","onwaiting","wait","show","killme","removeChild","comps","remove","kill","onClicZap","currentTime","distance","lastDistance","marker","nearMarker","i","length","blockInteractivity","unblockInteractivity","play"],"mappings":"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","file":"StageGameModule.js","sourcesContent":["import ModuleType from \"jx/core/presets/GameModule\";\n/**\n * Same as GameModule but with a StageView (this.stage)\n */\nexport default class StageGameModule extends ModuleType {\n    constructor(dataObject) {\n        super(Object.assign({\n            renderMode: \"canvas\",\n            stageWidth: null,\n            stageHeight: null,\n            ratio: null,\n            forceIOSStageResize: true\n        }, dataObject));\n    }\n    kill() {\n        if (this._killed)\n            return;\n        this.jx.playVideo = null;\n        super.kill();\n        this.stage = null;\n    }\n    appFreeze() {\n        //console.log(\"freeze\", this);\n        if (this._appFreezed)\n            return false;\n        this._stateBeforeFreeze = {};\n        super.appFreeze();\n    }\n    appUnfreeze() {\n        //console.log(\"unfreeze\", this);\n        if (!this._appFreezed)\n            return false;\n        super.appUnfreeze();\n    }\n    _preInit(callback) {\n        super._preInit(evt => {\n            this.stage = this.cc({ type: \"StageView\",\n                renderMode: this.dataObject.renderMode,\n                width: this.dataObject.stageWidth || this.jx.config.app.defaultStageResolution.width,\n                height: this.dataObject.stageHeight || this.jx.config.app.defaultStageResolution.height,\n                ratio: this.dataObject.ratio,\n                forceIOSStageResize: this.dataObject.forceIOSStageResize,\n                fixedStageScale: (this.dataObject.fixedStageScale !== undefined) ? this.dataObject.fixedStageScale : false\n            });\n            this.jx.playVideo = params => this.playVideo(params);\n            callback();\n        });\n    }\n    /**\n     */\n    playVideo({ id, loops = 0, zap = true, zapMarkers = null, bgMusicVolPC = 40, onfinished, onready, layerLevel = \"front\", autoplay = true }) {\n        this.jx._videosList = this.jx._videosList || {};\n        //-- Get video resource\n        let rid = this.choosenResolution ? id.toUpperCase() + \".VIDEO_\" + this.choosenResolution.str : id.toUpperCase() + \".VIDEO\";\n        let resource = this.jx.db.findOne({ id: rid });\n        if (!resource) {\n            rid = id;\n            resource = this.jx.db.findOne({ id: id });\n        }\n        if (!resource) {\n            console.error(\"Video resource\", id, \"not found\");\n            return;\n        }\n        //-- create video player\n        let video = this.cc({ id: id, type: \"Video\", loops: loops, render: \"DOM\", rid: rid, visible: false });\n        this.stage.addChild(video);\n        let view = $(video.view);\n        console.log(\"PARENT\", view.parent());\n        // video.view.css(\"z-index\", layerLevel == \"front\" ? 100 : 0);\n        //-- called when video finishes or user has clicked to zap it (if zap==true).\n        let finished = evt => {\n            video.onclick.removeAll();\n            video.onfinished.removeAll();\n            if (!video.view[0].paused)\n                video.view[0].pause();\n            this.jx.dj.music.volume = this.jx.dj.music.volumeOld;\n            onfinished({ target: video });\n        };\n        video.onfinished.addOnce(finished);\n        video.hasBeginPlay = false;\n        video.onplaying.add(evt => {\n            video.onplaying.removeAll();\n            video.hasBeginPlay = true;\n            this.jx.loadingScreen.hide();\n            this.jx.dj.music.volumeOld = this.jx.dj.music.volume;\n            this.jx.dj.music.volume = this.jx.dj.music.volume * bgMusicVolPC / 100;\n            video.fitIn({ x: 0, y: 0, width: this.stage.width, height: this.stage.height, alignV: \"middle\" });\n            onready({ target: video });\n        });\n        video.onwaiting.add(evt => {\n            this.jx.wait(800, evt => {\n                if (!video.hasBeginPlay)\n                    this.jx.loadingScreen.show();\n            });\n        });\n        video.killme = () => {\n            this.stage.removeChild(video);\n            this.comps.remove(video);\n            video.kill(false);\n        };\n        let onClicZap = () => {\n            if (zapMarkers) {\n                let currentTime = video.currentTime;\n                let distance, lastDistance, marker, nearMarker;\n                for (var i = 0; i < zapMarkers.length; i++) {\n                    marker = zapMarkers[i];\n                    distance = marker - currentTime;\n                    if (distance > 0 && (!lastDistance || distance < lastDistance)) {\n                        lastDistance = distance;\n                        nearMarker = marker;\n                    }\n                }\n                if (nearMarker) {\n                    video.currentTime = nearMarker;\n                }\n                else {\n                    finished({ target: video });\n                }\n            }\n            else {\n                finished({ target: video });\n            }\n        };\n        if (zap) {\n            if (layerLevel == \"front\") {\n                video.onclick.add(onClicZap);\n            }\n            else if (layerLevel == \"back\") {\n                this.jx.blockInteractivity(() => {\n                    this.jx.unblockInteractivity();\n                    onClicZap();\n                });\n            }\n        }\n        ;\n        if (autoplay)\n            video.play();\n        return video;\n    }\n}\n"]}