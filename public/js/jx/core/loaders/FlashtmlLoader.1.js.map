{"version":3,"sources":["../../../../src/jx/core/loaders/FlashtmlLoader.1.js"],"names":["FlashtmlLoader","resource","onFinished","jx","success","_loader","window","_useFlaName","fileJSName","src","split","pop","fileID","db","importJSFile","console","log","evt","error","globalID","data","libImage","_loadLib","lib","properties","manifest","length","createjs","LoadQueue","installPlugin","Sound","addEventListener","e","_fileload","_loadedError","_loadedAll","i","loadManifest","removeAllEventListeners","removeAll","destroy","event","removeEventListener","ssMetadata","name","SpriteSheet","getResult","frames","ready","target","item","type","id","result"],"mappings":"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","file":"FlashtmlLoader.1.js","sourcesContent":["export default class FlashtmlLoader {\n    constructor(resource, onFinished, jx) {\n        this.jx = jx;\n        //alert(resource.id)\n        this.resource = resource;\n        this.onFinished = onFinished;\n        this.success = false;\n        this._loader = null;\n        window[\"ss\"] = window[\"ss\"] || {};\n        this._useFlaName = true;\n    }\n    load() {\n        var fileJSName = this.resource.src.split(\"/\").pop();\n        this.fileID = fileJSName;\n        this.jx.db.importJSFile([this.resource.src + \"/html5/screen.js\"], evt => {\n            console.log(evt);\n            if (evt && evt.error) {\n                this.jx.db.importJSFile([this.resource.src + \"/html5/\" + fileJSName + \".js\"], evt => {\n                    this.globalID = fileJSName;\n                    this.resource.data = window[this.globalID];\n                    this.libImage = window[fileJSName + \"_images\"] = window[fileJSName + \"_images\"] || {};\n                    window[this.globalID + \"_images\"] = null;\n                    window[this.globalID] = null;\n                    //this.onFinished ({target:this, resource:this.resource});\n                    this._loadLib();\n                });\n            }\n            else {\n                this.globalID = \"screen\";\n                this.resource.data = window[this.globalID];\n                this.libImage = window[fileJSName + \"_images\"] = window[fileJSName + \"_images\"] || {};\n                window[this.globalID + \"_images\"] = null;\n                window[this.globalID] = null;\n                //this.onFinished ({target:this, resource:this.resource});\n                this._loadLib();\n            }\n        });\n        // if (this._useFlaName) {\n        // \tlet classPath;\n        // \tif (this.jx.db.classDefined(this.resource.src + \"/html5/screen.js\")) {\n        // \t\tclassPath = this.resource.src + \"/html5/screen.js\";\n        // \t\tthis.globalID = \"screen\";\n        // \t}\n        // \telse {\n        // \t\tclassPath = this.resource.src + \"/html5/\" + fileJSName + \".js\";\n        // \t\tthis.globalID = fileJSName;\n        // \t}\n        // \tthis.jx.db.importJSFile([ classPath ], ()  => {\n        // \t\tthis.resource.data = window[ this.globalID ]; \n        // \t\t//this.onFinished ({target:this, resource:this.resource});\n        // \t\tthis._loadLib();\n        // \t});\n        // }\n        // else {\n        // \tthis.jx.db.importJSFile([ this.resource.src + \"/html5/screenXX.js\" ], ()  => {\n        // \t\tthis.resource.data = window[ \"screenXX\" ]; \n        // \t\tthis.libImage = window[\"screenXX_images\"] = window[\"screenXX_images\"] ||  {} ;\n        // \t\twindow[\"screenXX_images\"] = null;\n        // \t\twindow[ \"screenXX\" ] = null;\n        // \t\t//this.onFinished ({target:this, resource:this.resource});\n        // \t\tthis._loadLib();\n        // \t});\n        // }\n    }\n    _loadLib() {\n        this.lib = this.resource.data;\n        if (this.lib.properties.manifest.length > 0) {\n            //--- Load internals medias export by Flash\n            this._loader = new createjs.LoadQueue();\n            this._loader.installPlugin(createjs.Sound);\n            this._loader.addEventListener(\"fileload\", (e) => this._fileload(e));\n            this._loader.addEventListener(\"error\", (e) => this._loadedError(e));\n            this._loader.addEventListener(\"complete\", (e) => this._loadedAll(e));\n            //(e)=>this._loadedAll(e) );\n            //console.log( this.lib.properties.manifest )\n            for (var i = 0; i < this.lib.properties.manifest.length; i++) {\n                this.lib.properties.manifest[i].src = this.resource.src + \"/html5/\" + this.lib.properties.manifest[i].src;\n            }\n            ;\n            this._loader.loadManifest(this.lib.properties.manifest);\n        }\n        else {\n            this._loadedAll();\n        }\n    }\n    kill() {\n        if (!this.jx)\n            return;\n        if (this._loader) {\n            this._loader.removeAllEventListeners();\n            this._loader.removeAll();\n            this._loader.destroy();\n            this._loader = null;\n        }\n        this.onFinished = null;\n        this.resource = null;\n        //if (window[this.fileID + \"_images\"]) window[this.fileID + \"_images\"] = null;\n        this.jx = null;\n    }\n    _loadedAll(event) {\n        //--- On instancie le clip\n        if (this._loader != null) {\n            this._loader.removeEventListener(\"fileload\", this._fileload);\n            this._loader.removeEventListener(\"error\", this._loadedError);\n            this._loader.removeEventListener(\"complete\", this._loadedAll);\n            var ssMetadata = this.lib.ssMetadata;\n            if (ssMetadata) {\n                for (var i = 0; i < ssMetadata.length; i++) {\n                    window[\"ss\"][ssMetadata[i].name] = new createjs.SpriteSheet({ \"images\": [this._loader.getResult(ssMetadata[i].name)], \"frames\": ssMetadata[i].frames });\n                }\n            }\n        }\n        this.resource.ready = true;\n        this.onFinished({ target: this, resource: this.resource, success: true });\n    }\n    _loadedError(event) {\n        //alert(\"flashtml failed \"+this.resource.src );\n        this._loader.removeEventListener(\"fileload\", this._fileload);\n        this._loader.removeEventListener(\"error\", this._loadedError);\n        this._loader.removeEventListener(\"complete\", this._loadedAll);\n        this.onFinished({ target: this, resource: this.resource, success: false });\n    }\n    _fileload(event) {\n        //console.log( event );\n        if (event.item.type == \"image\") {\n            // if (this._useFlaName) {\n            // \tvar libImage = window[this.fileID + \"_images\"] = window[this.fileID + \"_images\"] ||  {} ;\n            // \tlibImage[ event.item.id ] = event.result;\n            // }\n            // else {\n            // var libImage = window[this.fileID + \"_images\"] = window[this.fileID + \"_images\"] ||  {} ;\n            this.libImage[event.item.id] = event.result;\n            // }\n        }\n    }\n    _resourceLoaded(event) {\n    }\n    _resourceFailed(event) {\n    }\n}\n"]}