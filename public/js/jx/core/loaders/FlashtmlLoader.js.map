{"version":3,"sources":["../../../../src/jx/core/loaders/FlashtmlLoader.js"],"names":["FlashtmlLoader","resource","onFinished","jx","success","_loader","_useFlaName","lib","ideVersion","ssMetadata","window","fileID","fileJSName","src","split","pop","db","importJSFile","data","_loadLinkedAssets","globalID","evt","error","analyseFile","versionIDE","ide","version","_getLibBefore2019","_getLibAfter2019","console","mainSymbolID","libImage","libSpriteSheet","warn","id","Object","keys","compositions","fileAN","getComposition","getLibrary","getImages","getSpriteSheet","flaID","properties","manifest","length","createjs","LoadQueue","config","system","audio","isWebAudioSupported","installPlugin","Sound","addEventListener","e","_onFileLoaded","_onLoadError","_onAllLoaded","i","loadManifest","event","item","type","result","removeEventListener","target","_loadSpriteSheets","ready","name","SpriteSheet","getResult","frames","removeAllEventListeners","removeAll","destroy"],"mappings":"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","file":"FlashtmlLoader.js","sourcesContent":["export default class FlashtmlLoader {\n    constructor(resource, onFinished, jx) {\n        this.jx = jx;\n        this.resource = resource;\n        this.onFinished = onFinished;\n        this.success = false;\n        this._loader = null;\n        this._useFlaName = false;\n    }\n    getFlashVersion(lib) {\n        let ideVersion;\n        if (lib.ssMetadata == null) {\n            ideVersion = \"flash\";\n        }\n        else if (window[this.fileID] == null) {\n            ideVersion = \"animate\";\n        }\n        else {\n            ideVersion = \"animate2019\";\n        }\n        return ideVersion;\n    }\n    load() {\n        var fileJSName = this.resource.src.split(\"/\").pop();\n        this.fileID = fileJSName;\n        if (this._useFlaName) {\n            this.jx.db.importJSFile([this.resource.src + \"/html5/\" + fileJSName + \".js\"], () => {\n                this.resource.data = window[fileJSName];\n                this._loadLinkedAssets();\n            });\n        }\n        else {\n            let globalID;\n            this.jx.db.importJSFile([this.resource.src + \"/html5/screen.js\"], evt => {\n                if (evt && evt.error) {\n                    this.jx.db.importJSFile([this.resource.src + \"/html5/\" + fileJSName + \".js\"], () => {\n                        globalID = fileJSName;\n                        this.analyseFile(globalID, fileJSName);\n                        this._loadLinkedAssets();\n                    });\n                }\n                else {\n                    globalID = \"screen\";\n                    this.analyseFile(globalID, fileJSName);\n                    this._loadLinkedAssets();\n                }\n            });\n        }\n    }\n    analyseFile(globalID, fileJSName) {\n        let versionIDE;\n        if (window[globalID]) {\n            this.lib = window[globalID];\n            if (this.lib.ssMetadata == null) {\n                versionIDE = { ide: \"flash\", version: 0 };\n            }\n            else {\n                versionIDE = { ide: \"animate\", version: \"2017\" };\n            }\n            this._getLibBefore2019(globalID, fileJSName);\n        }\n        else if (window[\"AdobeAn\"]) {\n            versionIDE = { ide: \"animate\", version: \"2019\" };\n            this._getLibAfter2019(globalID, fileJSName);\n        }\n        else {\n            console.error(\"Flashtml file format not recognized\", globalID);\n        }\n        this.resource.data = this.lib;\n        this.resource.mainSymbolID = fileJSName;\n        this.resource.versionIDE = versionIDE;\n    }\n    _getLibBefore2019(globalID, fileJSName) {\n        this.lib = window[globalID];\n        this.libImage = window[globalID + \"_images\"] = window[globalID + \"_images\"] || {};\n        window[\"ss\"] = window[\"ss\"] || {};\n        this.libSpriteSheet = window[\"ss\"];\n        try { // because block error on Edge browser (Assignment to read-only properties is not allowed in strict mode.\n            window[globalID + \"_images\"] = null;\n            window[globalID] = null;\n        }\n        catch (error) {\n            console.warn(error);\n        }\n    }\n    _getLibAfter2019(globalID, fileJSName) {\n        let id = Object.keys(window[\"AdobeAn\"].compositions)[0];\n        let fileAN = window[\"AdobeAn\"].getComposition(Object.keys(window[\"AdobeAn\"].compositions)[0]);\n        this.lib = fileAN.getLibrary();\n        this.libImage = fileAN.getImages();\n        this.libSpriteSheet = fileAN.getSpriteSheet();\n        this.resource.flaID = id;\n        delete window[\"AdobeAn\"].compositions[id];\n    }\n    _loadLinkedAssets() {\n        if (this.lib.properties.manifest.length > 0) {\n            this._loader = new createjs.LoadQueue(this.jx.config.system.audio.isWebAudioSupported);\n            this._loader.installPlugin(createjs.Sound);\n            this._loader.addEventListener(\"fileload\", (e) => this._onFileLoaded(e));\n            this._loader.addEventListener(\"error\", (e) => this._onLoadError(e));\n            this._loader.addEventListener(\"complete\", (e) => this._onAllLoaded(e));\n            for (var i = 0; i < this.lib.properties.manifest.length; i++) {\n                this.lib.properties.manifest[i].src = this.resource.src + \"/html5/\" + this.lib.properties.manifest[i].src;\n            }\n            ;\n            this._loader.loadManifest(this.lib.properties.manifest);\n        }\n        else {\n            this._onAllLoaded();\n        }\n    }\n    _onFileLoaded(event) {\n        if (event.item.type == \"image\") {\n            if (this._useFlaName) {\n                var libImage = window[this.fileID + \"_images\"] = window[this.fileID + \"_images\"] || {};\n                libImage[event.item.id] = event.result;\n            }\n            else {\n                this.libImage[event.item.id] = event.result;\n            }\n        }\n    }\n    _onLoadError(event) {\n        this._loader.removeEventListener(\"fileload\", this._onFileLoaded);\n        this._loader.removeEventListener(\"error\", this._onLoadError);\n        this._loader.removeEventListener(\"complete\", this._onAllLoaded);\n        this.onFinished({ target: this, resource: this.resource, success: false });\n    }\n    _onAllLoaded(event) {\n        if (this._loader != null) {\n            this._loader.removeEventListener(\"fileload\", this._onFileLoaded);\n            this._loader.removeEventListener(\"error\", this._onLoadError);\n            this._loader.removeEventListener(\"complete\", this._onAllLoaded);\n            this._loadSpriteSheets();\n        }\n        this.resource.ready = true;\n        this.onFinished({ target: this, resource: this.resource, success: true });\n    }\n    _loadSpriteSheets() {\n        var ssMetadata = this.lib.ssMetadata;\n        if (ssMetadata) {\n            for (var i = 0; i < ssMetadata.length; i++) {\n                this.libSpriteSheet[ssMetadata[i].name] = new createjs.SpriteSheet({ \"images\": [this._loader.getResult(ssMetadata[i].name)], \"frames\": ssMetadata[i].frames });\n            }\n        }\n    }\n    kill() {\n        if (!this.jx)\n            return;\n        if (this._loader) {\n            this._loader.removeAllEventListeners();\n            this._loader.removeAll();\n            this._loader.destroy();\n            this._loader = null;\n        }\n        this.onFinished = null;\n        this.resource = null;\n        this.jx = null;\n    }\n}\n"]}