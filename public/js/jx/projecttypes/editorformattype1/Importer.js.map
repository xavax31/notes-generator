{"version":3,"sources":["../../../../src/jx/projecttypes/editorformattype1/Importer.js"],"names":["Importer","jx","dataObject","Object","assign","url","projectJXData","console","log","projectType","projectData","onFinished","editor","popup","title","content","buttons","ok","label","no","onclose","evt","action","_loadJson","window","close","json","db","addResources","id","type","src","load","jsonResource","findOne","data","debug","warn","_jsonAnalyse","reload","projInfo","moduleJSON","_getEntryPointPath","moduleData","srcPath","resources","_getResources","styles","_getStyles","gabarit","_getGabarit","i","length","splice","projectGroupChildren","version","projectInfos","value","projectInformations","concat","newGabarit","projectJX","_applyPatch","saveJSON","reloadWindow","destURL","patchURL","callback","options","date","extExclude","fileExclude","dirExclude","treeOnly","merge","deleteSource","recursive","cloneDir","sourcePath","destPath","result","_destroy","resourceInfos","resourceArray","resourceInfo","resource","push","anims","_findInGabarit","modulejsonName","request","founded","results","prop","children"],"mappings":"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","file":"Importer.js","sourcesContent":["import JXObject from \"jx/core/JXObject\";\nimport Resource from \"jx/core/Resource\";\nimport ProjectData from \"jx/core/dataobjects/ProjectData\";\nimport ModuleData from \"jx/core/dataobjects/ModuleData\";\nexport default class Importer extends JXObject {\n    constructor(jx, dataObject) {\n        super({ jx });\n        this.dataObject =\n            Object.assign({\n                url: null,\n                projectJXData: null\n            }, dataObject);\n        console.log(this.dataObject);\n        this.projectType = this.dataObject.projectJXData.projectType;\n        this.projectData = new ProjectData();\n        this.projectData.url = this.dataObject.url;\n    }\n    importConfig(onFinished) {\n        this.jx.editor.popup({ title: \"Comfirmation de conversion\",\n            content: \"Ce projet doit être converti pour la nouvelle version de l'éditeur. Seul le fichier editor.json et project.jx sont adaptés (les dossiers public et le src de l'application non sont pas modifiés)\",\n            buttons: {\n                ok: { label: \"Convertir\" },\n                no: { label: \"Annuler\" }\n            },\n            onclose: evt => {\n                if (evt.action == \"ok\") {\n                    this.onFinished = onFinished;\n                    this._loadJson();\n                }\n                else {\n                    window.close();\n                }\n            } });\n    }\n    _loadJson() {\n        this.json = null;\n        this.jx.db.addResources({ id: 'editorJSON', type: \"json\", src: this.projectData.url + \"/etc/editor/editor.json\" });\n        this.jx.db.load({ id: 'editorJSON' }, evt => {\n            var jsonResource = this.jx.db.findOne({ id: 'editorJSON' });\n            if (!jsonResource || !jsonResource.data) {\n                this.jx.debug.warn(\"editor.json doesn't exist or is broken\");\n                this.jx.editor.popup({ title: \"Error\", content: \"editor.json doesn't exist or is broken\" });\n                return;\n            }\n            this.json = jsonResource.data;\n            this._jsonAnalyse();\n        }, {\n            reload: true\n        });\n    }\n    _jsonAnalyse() {\n        var projInfo = this.json[\"ProjectInformations\"];\n        //-- get module part of json and fill ModuleData object\n        this.moduleJSON = this.json[\"entry-point\"][this._getEntryPointPath()];\n        var moduleData = new ModuleData();\n        moduleData.srcPath = this._getEntryPointPath();\n        moduleData.resources = this._getResources();\n        moduleData.styles = this._getStyles();\n        moduleData.gabarit = this._getGabarit();\n        for (var i = 0; i < moduleData.gabarit.length; i++) {\n            if (moduleData.gabarit[i].id == \"Informations\") {\n                moduleData.gabarit.splice(i, 1);\n            }\n        }\n        ;\n        var projectGroupChildren = [\n            {\n                \"id\": \"Informations\",\n                \"type\": \"DataObject\",\n                \"children\": [\n                    {\n                        \"id\": \"project\",\n                        \"type\": \"ProjectInformation\",\n                        \"description\": \"Configuration globale du projet\",\n                        \"value\": {\n                            \"id\": projInfo.id,\n                            \"type\": \"ApplicationBabelHTML5OldFormat\",\n                            \"description\": \"\",\n                            \"version\": projInfo.version,\n                            \"appCodeVersion\": \"intern: src v1.0\",\n                            \"gitRepository\": \"\",\n                            \"status\": \"done\",\n                            \"dateValidation\": \"\",\n                            \"dateGabarit\": \"\",\n                            \"devNumDaysCode\": 0,\n                            \"dateBeta\": \"\",\n                            \"devNumDaysDebug\": 0,\n                            \"dateRelease\": \"\",\n                            \"datePublication\": \"\",\n                            \"devNumDaysCleanup\": 0,\n                            \"publication\": \"all\",\n                            \"Langues\": \"fr\",\n                            \"Doc\": \"<a href='url.com' target='_blank' >Doc Moteur</a> \",\n                            \"BugReport\": \"<a href='url.com' target='_blank' >Bug Report link</a>\"\n                        }\n                    },\n                    {\n                        \"id\": \"engine\",\n                        \"type\": \"JXEngineInformation\",\n                        \"description\": \"Configuration liée à la technologie utilisée (cf project.type)\",\n                        \"value\": {\n                            \"type\": \"jx-engine\",\n                            \"jxVersion\": \"intern: src/jx v0.9\",\n                            \"modulePath\": \".\",\n                            \"mainCtrl\": \"index\",\n                            \"srcPath\": \"js/src\",\n                            \"defaultViewType\": \"CJS\",\n                            \"screenRatio\": \"auto\",\n                            \"framerate\": 50\n                        }\n                    }\n                ]\n            },\n            {\n                \"id\": \"Resources\",\n                \"type\": \"Group\",\n                \"visible\": \"admin,dev\",\n                \"children\": moduleData.resources\n            },\n            {\n                \"id\": \"Scenario\",\n                \"type\": \"Group\",\n                \"children\": [\n                    {\n                        \"id\": \"ScenarioFile\",\n                        \"type\": \"FileItem\",\n                        \"description\": \"scenar\",\n                        \"asset\": {\n                            \"type\": \"PDF\",\n                            \"src\": \"doc/JEU01.pdf\"\n                        },\n                        \"visible\": true,\n                        \"editable\": true\n                    },\n                    {\n                        \"id\": \"Commentaires\",\n                        \"type\": \"Text\",\n                        \"editable\": true,\n                        \"description\": \"Décrire ici les modifications souhaitées par rapport au modèle actuel.\",\n                        \"value\": \"\",\n                        \"visible\": true\n                    }\n                ]\n            },\n            {\n                \"id\": \"Configuration\",\n                \"type\": \"DataObject\",\n                \"description\": \"Contient les paramêtres propre à cette application.\",\n                \"children\": []\n            }\n        ];\n        var projectInfos = {};\n        for (var i = 0; i < projectGroupChildren.length; i++) {\n            projectInfos[projectGroupChildren[i].id] = projectGroupChildren[i].value;\n        }\n        ;\n        this.projectData.projectInformations = projectInfos;\n        moduleData.gabarit = projectGroupChildren.concat(moduleData.gabarit).concat(moduleData.styles);\n        console.log(moduleData.gabarit);\n        // new gabarit\n        var newGabarit = {\n            \"formatJSON\": \"SimpleJSON2\",\n            \"projectData\": moduleData.gabarit\n        };\n        var projectJX = {\n            \"projectType\": \"ApplicationBabelHTML5OldFormat\"\n        };\n        console.log(newGabarit);\n        this._applyPatch(this.projectData.url, \"$bobaLastRelease/patches/fromv0.9\", evt => {\n            this.jx.db.saveJSON(this.projectData.url + \"/project.jx\", projectJX, evt => {\n                this.jx.db.saveJSON(this.projectData.url + \"/etc/editor/editor.json\", newGabarit, evt => {\n                    this.jx.editor.reloadWindow();\n                });\n            });\n        });\n        // this.projectData.modules.push(moduleData);\n        // moduleData.moduleClass = null;\n        // this._finish();\n        //--- load module main class (not used and import not work anymore here. don't know why, this worked before)\n        //requirejs([moduleData.srcPath + \"/index\"], (Module) => {\n        // moduleData.moduleClass = Module;\n        // this._finish();\n        //});\n    }\n    /** */\n    _applyPatch(destURL, patchURL, callback) {\n        console.log(\"buildProjectLastReleaseJX\");\n        var options = {\n            date: false,\n            extExclude: [],\n            fileExclude: [],\n            dirExclude: [],\n            treeOnly: false,\n            merge: true,\n            deleteSource: false,\n            recursive: 10000 // level of recursivity in directories\n        };\n        this.jx.editor.cloneDir({\n            sourcePath: patchURL,\n            destPath: destURL,\n            options: options\n        }, (result) => {\n            callback();\n        });\n    }\n    _finish() {\n        this._destroy();\n        this.onFinished(this.projectData);\n    }\n    _destroy() {\n        //this.jx.db.removeResources({id:'editorJSON'});\n    }\n    _getResources() {\n        var resourceInfos = this.moduleJSON[\"resources\"];\n        var resourceArray = [];\n        for (var i = 0; i < resourceInfos.length; i++) {\n            var resourceInfo = resourceInfos[i];\n            var resource = new Resource(resourceInfo);\n            resourceArray.push(resource);\n        }\n        return resourceArray;\n    }\n    _getStyles() {\n        return this.moduleJSON[\"styles\"] || [];\n    }\n    _getGabarit() {\n        var gabarit = this.moduleJSON[\"gabarit\"] || [];\n        var anims = this._findInGabarit(gabarit, { type: \"Animation\" });\n        console.log(anims);\n        for (var i = 0; i < anims.length; i++) {\n            anims[i].type = \"Flashtml\";\n        }\n        ;\n        console.log(gabarit);\n        return gabarit;\n    }\n    _getEntryPointPath() {\n        for (var modulejsonName in this.json[\"entry-point\"]) {\n            return modulejsonName;\n            break;\n        }\n    }\n    _findInGabarit(gabarit, request) {\n        var founded;\n        var results = [];\n        for (var i = 0; i < gabarit.length; i++) {\n            founded = true;\n            for (var prop in request) {\n                if (request[prop] != gabarit[i][prop]) {\n                    founded = false;\n                    break;\n                }\n            }\n            if (founded) {\n                results.push(gabarit[i]);\n            }\n            if (gabarit[i].children) {\n                results = results.concat(this._findInGabarit(gabarit[i].children, request));\n            }\n            ;\n        }\n        ;\n        return results;\n    }\n}\n"]}